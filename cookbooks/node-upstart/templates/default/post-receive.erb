#!/bin/sh
# post-receive.erb
# Generated by Chef for <%= node['hostname'] %>.
# Local modifications will be overwritten.
# This script is located in <%= @remote_hooks %>
# and run after pushing an update to this remote repository via `git push ec2 $branch`.
# http://blog.ekynoxe.com/2011/10/22/git-post-receive-for-multiple-remote-branches-and-work-trees/

GIT_WORK_TREE=<%= @app_dir %>
export GIT_WORK_TREE

while read oldrev newrev ref
do
  branch=`echo $ref | cut -d/ -f3`
  echo current branch: $branch
  git --work-tree=$GIT_WORK_TREE checkout -f $branch
done

echo current work tree: $GIT_WORK_TREE
cd $GIT_WORK_TREE

sudo npm rebuild

sudo reload <%= @service %>