#!upstart
# <%= @app_name %>.conf
# Generated by Chef for <%= node['hostname'] %>.
# node-app.conf.erb
# Local modifications will be overwritten.
# This script is to be placed in /etc/init to work with upstart.
#
# Internally the 'initctl' command is used to manage:
# initctl help
# initctl status <%= @app_name %>
# initctl reload <%= @app_name %>
# initctl start <%= @app_name %>

# http://clock.co.uk/tech-blogs/upstart-and-nodejs

description "<%= @app_name %> upstart script"
author      "Vincent Mac <vincent@simplicity.io>"
version     "1.0.1"

start on (local-filesystems and net-device-up)
stop on shutdown

instance "node-<%= @app_name %>"

# Automatically Respawn
respawn
respawn limit 5 60

# Increase max open files (ulimit) from default @ 1024
limit nofile 32768 32768

# env HOME=/root

script
  #set -e

  export HOME="/root"

  echo $$ > /var/run/<%= @app_name %>.pid

  # exec sudo -u www-data /usr/bin/node /var/www/app_name/app.js 2>&1 >> /var/log/node/app_name
  # exec sudo -u <%= @user %> NODE_ENV=production <%= @node_bin %> <%= @app %> >> <%= @log_path %> 2>&1

  exec sudo -u <%= @user %> PORT=<%= @port %> NODE_ENV=<%= @node_env %> n use <%= @node_version %> <%= @app_bin %> >> <%= @log_path %> 2>&1


end script

pre-start script
    # Date format same as (new Date()).toISOString() for consistency
    echo "[`date -u +%Y-%m-%dT%T.%3NZ`] (sys) Starting" >> <%= @log_path %>
end script

pre-stop script
    rm /var/run/<%= @app_name %>.pid
    echo "[`date -u +%Y-%m-%dT%T.%3NZ`] (sys) Stopping" >> <%= @log_path %>
end script