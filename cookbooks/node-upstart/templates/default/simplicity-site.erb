# simplicity-site.erb
# Generated by Chef for <%= node['hostname'] %>.
# Local modifications will be overwritten.

upstream simplicity_node {
  server 127.0.0.1:<%= node['node-upstart']['simplicity']['port'] %>;
}

# 301 redirect www to apex
server {
  listen 80;
  server_name www.<%= node['node-upstart']['simplicity']['site'] %>;
  return 301 http://<%= node['node-upstart']['simplicity']['site'] %>$request_uri;
}

# Main Site Configuration
server {
  listen 80 default_server;
  server_name <%= node['node-upstart']['simplicity']['site'] %>;

  access_log <%= node['nginx']['log_dir'] %>/<%= node['node-upstart']['simplicity']['site'] %>.log;

  location / {
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded_for $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-NginX-Proxy true;
    proxy_pass_header Server;
    #server_tokens off;

    proxy_pass http://simplicity_node/;
    proxy_redirect off;
  }
}

# AWS Login Routing
server {
  listen 80;
  server_name aws.<%= node['node-upstart']['simplicity']['site'] %>;
  return 301 https://<%= node['node-upstart']['simplicity']['aws_signin'] %>.signin.aws.amazon.com/console;
  access_log <%= node['nginx']['log_dir'] %>/aws.<%= node['node-upstart']['simplicity']['site'] %>.log;
}